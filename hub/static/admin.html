<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin â€” Linart Hub</title>
  <style>
    :root { font-family: Inter, Segoe UI, Arial, sans-serif; color: #0b1220; background: #f6f8fb; }
    body { margin: 0; padding: 32px; }
    .layout { max-width: 960px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 28px; box-shadow: 0 20px 40px rgba(12, 24, 48, 0.08); }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    header h1 { margin: 0; font-size: 1.8rem; }
    header a { color: #2563eb; text-decoration: none; font-weight: 600; }
    section { margin-bottom: 32px; }
    section:last-of-type { margin-bottom: 0; }
    h2 { margin: 0 0 12px; font-size: 1.35rem; }
    h3 { margin-top: 0; font-size: 1.12rem; }
    .branding-card,
    .hero-card { display: flex; gap: 18px; align-items: flex-start; background: #f3f6fb; border: 1px solid #e6eef8; border-radius: 10px; padding: 16px; }
    .branding-card img { width: 96px; height: 96px; object-fit: contain; border-radius: 10px; background: #fff; border: 1px solid #dbe2ee; }
    .branding-card .controls,
    .hero-controls { display: flex; flex-direction: column; gap: 10px; flex: 1; }
    label.inline { display: flex; flex-direction: column; font-size: 0.9rem; gap: 6px; }
    label.inline input[type="text"],
    label.inline input[type="url"],
    label.inline input[type="password"],
    label.inline textarea { padding: 8px 10px; border-radius: 8px; border: 1px solid #dbe2ee; font: inherit; background: #fff; }
    label.inline textarea { min-height: 110px; resize: vertical; }
    button,
    label.button { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; background: #2563eb; color: #fff; font-weight: 600; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 8px; }
    label.button { position: relative; overflow: hidden; }
    label.button input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    button.secondary { background: #f3f6fb; color: #1b263b; border: 1px solid #dbe2ee; }
    .services-grid { display: flex; flex-direction: column; gap: 16px; }
    .service-card { display: flex; gap: 16px; border: 1px solid #e6eef8; border-radius: 10px; padding: 16px; background: #fafcff; align-items: center; }
    .service-card img { width: 72px; height: 72px; object-fit: contain; border: 1px solid #dbe2ee; border-radius: 8px; background: #fff; }
    .service-card .info { flex: 1; }
    .service-card .info strong { font-size: 1.05rem; display: block; margin-bottom: 2px; }
    .meta { color: #556370; font-size: 0.85rem; line-height: 1.4; }
    .service-card .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    form#add { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    form#add label { display: flex; flex-direction: column; gap: 6px; font-size: 0.9rem; }
    form#add input[type="text"], form#add input[type="url"] { padding: 8px 10px; border-radius: 8px; border: 1px solid #dbe2ee; font: inherit; }
    .form-actions { grid-column: 1 / -1; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .hint { font-size: 0.8rem; color: #697588; }
    .hero-preview { width: 240px; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; }
    .hero-preview video { width: 100%; border-radius: 12px; border: 1px solid #dbe2ee; background: #000; }
    .hero-preview video.is-hidden { display: none; }
    .hero-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .hero-slider { display: flex; align-items: center; gap: 12px; }
    .hero-slider input[type="range"] { width: 180px; }
    .badge-small { padding: 2px 8px; border-radius: 999px; background: #e0e7ff; color: #1d4ed8; font-size: 0.75rem; font-weight: 600; }
    .card-form { background: #f3f6fb; border: 1px solid #e6eef8; border-radius: 10px; padding: 16px; display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .card-form .full { grid-column: 1 / -1; display: flex; gap: 12px; flex-wrap: wrap; }
    .card-form button { align-self: flex-start; }
    .status-success { color: #166534; }
    .status-error { color: #b91c1c; }
    @media (max-width: 760px) {
      body { padding: 16px; }
      .branding-card, .hero-card { flex-direction: column; }
      .hero-preview { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <h1>Admin panel</h1>
      <a class="link-back" href="/">&larr; Back to hub</a>
    </header>

    <section>
      <h2>Site branding</h2>
      <div class="branding-card">
        <img id="siteLogoPreview" src="/static/logo1.svg" alt="Site logo">
        <div class="controls">
          <label class="inline">
            Site title
            <input type="text" id="siteTitleInput" placeholder="Linart Systems">
          </label>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <label class="button">Upload logo<input type="file" id="siteLogoFile" accept="image/*"></label>
            <button type="button" class="secondary" id="siteLogoReset">Reset to default</button>
            <button type="button" id="saveBranding">Save changes</button>
          </div>
          <div class="hint">Accepted formats: PNG, JPG, SVG, GIF, WEBP. Max 5&nbsp;MB.</div>
        </div>
      </div>
    </section>

    <section>
      <h2>Welcome hero</h2>
      <div class="hero-card">
        <div class="hero-preview">
          <span class="badge-small">Background video</span>
          <video id="heroVideoPreview" controls muted loop playsinline></video>
          <div class="hint">If no video is uploaded, a static gradient is shown.</div>
        </div>
        <div class="hero-controls">
          <label class="inline">
            Intro title
            <input type="text" id="introTitleInput" placeholder="Welcome to my server!">
          </label>
          <label class="inline">
            Intro message
            <textarea id="introBodyInput" placeholder="Tell visitors who you are and what this hub does."></textarea>
          </label>
        <label class="inline">
          WhatsApp number
          <input type="text" id="whatsappInput" placeholder="+49123456789">
        </label>
        <label class="inline">
          Overlay color
          <input type="color" id="heroOverlayColorInput" value="#05060b">
        </label>
        <div class="hero-slider">
          <label class="inline" style="flex:1;">
            Overlay opacity
            <input type="range" id="heroOverlayOpacityInput" min="0" max="100" step="1" value="85">
          </label>
          <strong id="heroOverlayOpacityValue">85%</strong>
        </div>
        <div class="hero-slider">
          <label class="inline" style="flex:1;">
            Video blur
            <input type="range" id="heroBlurInput" min="0" max="40" step="1">
          </label>
            <strong id="heroBlurValue">0</strong>
          </div>
          <div class="hero-buttons">
            <label class="button">Upload hero video<input type="file" id="heroVideoFile" accept="video/mp4,video/webm,video/ogg"></label>
            <button type="button" class="secondary" id="heroVideoRemove">Remove video</button>
            <button type="button" id="saveHero">Save hero</button>
          </div>
          <div class="hint">Recommended: MP4/WebM up to ~50&nbsp;MB. Video plays muted, loops, and is blurred using the value above.</div>
        </div>
      </div>
    </section>

    <section>
      <h2>Services</h2>
      <div id="servicesList" class="services-grid"></div>
    </section>

    <section>
      <h3>Add service</h3>
      <form id="add">
        <label>
          Name (ID)
          <input name="name" type="text" placeholder="service3" required>
        </label>
        <label>
          Display name
          <input name="displayName" type="text" placeholder="My new service">
        </label>
        <label>
          Description
          <input name="description" type="text" placeholder="What this service does">
        </label>
        <label>
          Target URL
          <input name="target" type="url" placeholder="http://service3:3002" required>
        </label>
        <label>
          Prefix
          <input name="prefix" type="text" placeholder="/service3">
        </label>
        <label>
          Logo URL
          <input name="logo" type="text" placeholder="/static/uploads/service3.png">
        </label>
        <label class="button">
          Upload logo
          <input type="file" id="addLogoFile" accept="image/*">
        </label>
        <div class="form-actions">
          <button type="submit">Add service</button>
          <span class="hint">Upload file to autofill logo URL or paste an existing path.</span>
        </div>
      </form>
    </section>

    <section>
      <h2>Security</h2>
      <form id="passwordForm" class="card-form">
        <label class="inline">
          Current password
          <input type="password" id="currentPasswordInput" required>
        </label>
        <label class="inline">
          New password
          <input type="password" id="newPasswordInput" minlength="6" required>
        </label>
        <label class="inline">
          Confirm password
          <input type="password" id="confirmPasswordInput" minlength="6" required>
        </label>
        <div class="full">
          <button type="submit">Change password</button>
          <span class="hint">Minimum 6 characters. Session will stay active after change.</span>
          <span id="passwordStatus"></span>
        </div>
      </form>
    </section>
  </div>

  <script>
    const state = {
      config: {
        siteLogo: '/static/logo1.svg',
        siteTitle: 'Linart Systems',
        introTitle: '',
        introBody: '',
        contactWhatsapp: '',
        heroVideo: '',
        heroVideoBlur: 8,
        heroOverlayColor: '#05060b',
        heroOverlayOpacity: 0.85,
      },
      services: []
    };

    function handleError(error) {
      console.error(error);
      alert(error.message || 'Unexpected error');
    }

    async function fetchJson(url, options) {
      const response = await fetch(url, options);
      const data = await response.json().catch(() => ({}));
      if (!response.ok || (data && data.ok === false)) {
        throw new Error((data && data.error) || response.statusText || 'Request failed');
      }
      return data;
    }

    async function uploadAsset(file) {
      const form = new FormData();
      form.append('logo', file);
      const data = await fetchJson('/admin/upload-logo', { method: 'POST', body: form });
      return data.path;
    }

    const siteLogoPreview = document.getElementById('siteLogoPreview');
    const siteTitleInput = document.getElementById('siteTitleInput');
    const heroVideoPreview = document.getElementById('heroVideoPreview');
    const heroVideoFile = document.getElementById('heroVideoFile');
    const heroVideoRemove = document.getElementById('heroVideoRemove');
    const introTitleInput = document.getElementById('introTitleInput');
    const introBodyInput = document.getElementById('introBodyInput');
    const whatsappInput = document.getElementById('whatsappInput');
    const heroOverlayColorInput = document.getElementById('heroOverlayColorInput');
    const heroOverlayOpacityInput = document.getElementById('heroOverlayOpacityInput');
    const heroOverlayOpacityValue = document.getElementById('heroOverlayOpacityValue');
    const heroBlurInput = document.getElementById('heroBlurInput');
    const heroBlurValue = document.getElementById('heroBlurValue');
    const servicesList = document.getElementById('servicesList');
    const passwordStatus = document.getElementById('passwordStatus');

    heroBlurInput.value = 8;
    heroBlurValue.textContent = '8';

    function renderBranding() {
      siteLogoPreview.src = state.config.siteLogo || '/static/logo1.svg';
      siteTitleInput.value = state.config.siteTitle || '';
    }

    function renderHero() {
      introTitleInput.value = state.config.introTitle || '';
      introBodyInput.value = state.config.introBody || '';
      whatsappInput.value = state.config.contactWhatsapp || '';

      heroOverlayColorInput.value = state.config.heroOverlayColor || '#05060b';
      const overlayOpacity = Number.isFinite(Number(state.config.heroOverlayOpacity))
        ? Math.max(0, Math.min(1, Number(state.config.heroOverlayOpacity)))
        : 0.85;
      heroOverlayOpacityInput.value = Math.round(overlayOpacity * 100);
      heroOverlayOpacityValue.textContent = heroOverlayOpacityInput.value + '%';

      heroBlurInput.value = Number.isFinite(Number(state.config.heroVideoBlur))
        ? Number(state.config.heroVideoBlur)
        : 8;
      heroBlurValue.textContent = heroBlurInput.value;

      if (state.config.heroVideo) {
        heroVideoPreview.src = state.config.heroVideo;
        heroVideoPreview.classList.remove('is-hidden');
        heroVideoPreview.load();
      } else {
        heroVideoPreview.removeAttribute('src');
        heroVideoPreview.classList.add('is-hidden');
        heroVideoPreview.load();
      }
    }

    function buildMeta(label, value) {
      const el = document.createElement('div');
      el.className = 'meta';
      el.textContent = `${label}: ${value}`;
      return el;
    }

    function renderServices() {
      servicesList.innerHTML = '';
      if (!state.services.length) {
        const empty = document.createElement('div');
        empty.className = 'meta';
        empty.textContent = 'No services registered yet.';
        servicesList.appendChild(empty);
        return;
      }

      state.services.forEach((service) => {
        const card = document.createElement('div');
        card.className = 'service-card';

        const logo = document.createElement('img');
        logo.src = service.logo || state.config.siteLogo || '/static/logo1.svg';
        logo.alt = `${service.displayName || service.name} logo`;
        card.appendChild(logo);

        const info = document.createElement('div');
        info.className = 'info';
        const title = document.createElement('strong');
        title.textContent = `${service.displayName || service.name} (${service.name})`;
        info.appendChild(title);
        if (service.description) {
          info.appendChild(buildMeta('Description', service.description));
        }
        info.appendChild(buildMeta('Target', service.target));
        info.appendChild(buildMeta('Prefix', service.prefix));
        card.appendChild(info);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const uploadLabel = document.createElement('label');
        uploadLabel.className = 'button';
        uploadLabel.textContent = 'Upload logo';
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        uploadLabel.appendChild(fileInput);
        fileInput.addEventListener('change', async (event) => {
          if (!event.target.files?.length) return;
          try {
            const path = await uploadAsset(event.target.files[0]);
            await fetchJson(`/admin/services/${encodeURIComponent(service.name)}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ logo: path })
            });
            await loadAll();
          } catch (error) {
            handleError(error);
          } finally {
            event.target.value = '';
          }
        });
        actions.appendChild(uploadLabel);

        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'secondary';
        clearBtn.textContent = 'Remove logo';
        clearBtn.addEventListener('click', async () => {
          try {
            await fetchJson(`/admin/services/${encodeURIComponent(service.name)}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ logo: '' })
            });
            await loadAll();
          } catch (error) {
            handleError(error);
          }
        });
        actions.appendChild(clearBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', async () => {
          if (!confirm(`Delete service "${service.name}"?`)) return;
          try {
            await fetchJson(`/admin/services/${encodeURIComponent(service.name)}`, { method: 'DELETE' });
            await loadAll();
          } catch (error) {
            handleError(error);
          }
        });
        actions.appendChild(deleteBtn);

        card.appendChild(actions);
        servicesList.appendChild(card);
      });
    }

    async function loadAll() {
      try {
        const [services, config] = await Promise.all([
          fetchJson('/admin/services'),
          fetchJson('/admin/config')
        ]);
        state.services = services;
        state.config = config;
        renderBranding();
        renderHero();
        renderServices();
      } catch (error) {
        handleError(error);
      }
    }

    document.getElementById('saveBranding').addEventListener('click', async () => {
      try {
        const siteTitle = siteTitleInput.value.trim();
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ siteTitle })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    document.getElementById('siteLogoReset').addEventListener('click', async () => {
      if (!confirm('Reset site logo to default?')) return;
      try {
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ siteLogo: '' })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    document.getElementById('siteLogoFile').addEventListener('change', async (event) => {
      if (!event.target.files?.length) return;
      try {
        const path = await uploadAsset(event.target.files[0]);
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ siteLogo: path })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      } finally {
        event.target.value = '';
      }
    });

    heroOverlayOpacityInput.addEventListener('input', () => {
      heroOverlayOpacityValue.textContent = heroOverlayOpacityInput.value + '%';
    });

    heroBlurInput.addEventListener('input', () => {
      heroBlurValue.textContent = heroBlurInput.value;
    });

    document.getElementById('saveHero').addEventListener('click', async () => {
      try {
        const payload = {
          introTitle: introTitleInput.value.trim(),
          introBody: introBodyInput.value.trim(),
          contactWhatsapp: whatsappInput.value.trim(),
          heroOverlayColor: heroOverlayColorInput.value,
          heroOverlayOpacity: Number(heroOverlayOpacityInput.value) / 100,
          heroVideoBlur: Number(heroBlurInput.value)
        };
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    heroVideoFile.addEventListener('change', async (event) => {
      if (!event.target.files?.length) return;
      const file = event.target.files[0];
      try {
        const path = await uploadAsset(file);
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ heroVideo: path })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      } finally {
        event.target.value = '';
      }
    });

    heroVideoRemove.addEventListener('click', async () => {
      if (!state.config.heroVideo) return;
      if (!confirm('Remove the current hero video?')) return;
      try {
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ heroVideo: '' })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    document.getElementById('add').addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = event.target;
      const fd = new FormData(form);
      const payload = {
        name: fd.get('name'),
        displayName: fd.get('displayName'),
        description: fd.get('description'),
        target: fd.get('target'),
        prefix: fd.get('prefix'),
        logo: fd.get('logo')
      };

      const fileInput = document.getElementById('addLogoFile');
      try {
        if (fileInput.files?.length) {
          payload.logo = await uploadAsset(fileInput.files[0]);
        }

        Object.keys(payload).forEach((key) => {
          if (typeof payload[key] === 'string') {
            const trimmed = payload[key].trim();
            payload[key] = trimmed || undefined;
          }
          if (payload[key] === undefined) {
            delete payload[key];
          }
        });

        await fetchJson('/admin/services', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        form.reset();
        if (fileInput) fileInput.value = '';
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    document.getElementById('passwordForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      passwordStatus.textContent = '';
      passwordStatus.className = '';

      const currentPassword = document.getElementById('currentPasswordInput').value;
      const newPassword = document.getElementById('newPasswordInput').value;
      const confirmPassword = document.getElementById('confirmPasswordInput').value;

      if (newPassword !== confirmPassword) {
        passwordStatus.textContent = 'Passwords do not match.';
        passwordStatus.className = 'status-error';
        return;
      }

      try {
        await fetchJson('/admin/password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword })
        });
        passwordStatus.textContent = 'Password updated.';
        passwordStatus.className = 'status-success';
        event.target.reset();
      } catch (error) {
        passwordStatus.textContent = error.message || 'Failed to update password.';
        passwordStatus.className = 'status-error';
      }
    });

    loadAll();
  </script>
</body>
</html>



