<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin â€” Linart Hub</title>
  <style>
    :root { font-family: Inter, Segoe UI, Arial, sans-serif; color: #0b1220; background: #f6f8fb; }
    body { margin: 0; padding: 32px; }
    .layout { max-width: 960px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 28px; box-shadow: 0 20px 40px rgba(12, 24, 48, 0.08); }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    header h1 { margin: 0; font-size: 1.8rem; }
    header a { color: #2563eb; text-decoration: none; font-weight: 600; }
    section { margin-bottom: 32px; }
    section:last-of-type { margin-bottom: 0; }
    h2 { margin: 0 0 12px; font-size: 1.35rem; }
    h3 { margin-top: 0; font-size: 1.12rem; }
    .branding-card,
    .hero-card { display: flex; gap: 18px; align-items: flex-start; background: #f3f6fb; border: 1px solid #e6eef8; border-radius: 10px; padding: 16px; }
    .branding-card img { width: 96px; height: 96px; object-fit: contain; border-radius: 10px; background: #fff; border: 1px solid #dbe2ee; }
    .branding-card .controls,
    .hero-controls { display: flex; flex-direction: column; gap: 10px; flex: 1; }
    .theme-controls { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); padding: 12px; border-radius: 10px; background: #fff; border: 1px solid #dbe2ee; }
    .theme-slider { display: flex; align-items: center; gap: 12px; }
    .theme-slider input[type="range"] { width: 180px; }
    label.inline { display: flex; flex-direction: column; font-size: 0.9rem; gap: 6px; }
    label.inline input[type="text"],
    label.inline input[type="url"],
    label.inline input[type="password"],
    label.inline textarea { padding: 8px 10px; border-radius: 8px; border: 1px solid #dbe2ee; font: inherit; background: #fff; }
    label.inline textarea { min-height: 110px; resize: vertical; }
    button,
    label.button { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; background: #2563eb; color: #fff; font-weight: 600; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 8px; }
    label.button { position: relative; overflow: hidden; }
    label.button input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    button.secondary { background: #f3f6fb; color: #1b263b; border: 1px solid #dbe2ee; }
    .services-grid { display: flex; flex-direction: column; gap: 16px; }
    .service-card { display: flex; gap: 16px; border: 1px solid #e6eef8; border-radius: 10px; padding: 16px; background: #fafcff; align-items: center; }
    .service-card img { width: 72px; height: 72px; object-fit: contain; border: 1px solid #dbe2ee; border-radius: 8px; background: #fff; }
    .service-card .info { flex: 1; }
    .service-card .info strong { font-size: 1.05rem; display: block; margin-bottom: 2px; }
    .meta { color: #556370; font-size: 0.85rem; line-height: 1.4; }
    .service-card .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    form#add { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    form#add label { display: flex; flex-direction: column; gap: 6px; font-size: 0.9rem; }
    form#add input[type="text"], form#add input[type="url"] { padding: 8px 10px; border-radius: 8px; border: 1px solid #dbe2ee; font: inherit; }
    .form-actions { grid-column: 1 / -1; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .hint { font-size: 0.8rem; color: #697588; }
    .hero-preview { width: 240px; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; }
    .hero-preview video { width: 100%; border-radius: 12px; border: 1px solid #dbe2ee; background: #000; }
    .hero-preview video.is-hidden { display: none; }
    .welcome-controls { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
    .welcome-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .welcome-thumb { width: 120px; height: 120px; border-radius: 12px; border: 1px solid #dbe2ee; background: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
    .welcome-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .welcome-thumb .placeholder { color: #94a3b8; font-size: 0.8rem; text-align: center; padding: 12px; }
    .welcome-image.is-hidden { display: none; }
    .hero-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .hero-slider { display: flex; align-items: center; gap: 12px; }
    .hero-slider input[type="range"] { width: 180px; }
    .badge-small { padding: 2px 8px; border-radius: 999px; background: #e0e7ff; color: #1d4ed8; font-size: 0.75rem; font-weight: 600; }
    .card-form { background: #f3f6fb; border: 1px solid #e6eef8; border-radius: 10px; padding: 16px; display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .card-form .full { grid-column: 1 / -1; display: flex; gap: 12px; flex-wrap: wrap; }
    .card-form button { align-self: flex-start; }
    .status-success { color: #166534; }
    .status-error { color: #b91c1c; }
    .social-list { display: flex; flex-direction: column; gap: 16px; margin-bottom: 18px; }
    .social-card { display: flex; gap: 16px; border: 1px solid #e6eef8; border-radius: 10px; padding: 16px; background: #fafcff; align-items: center; flex-wrap: wrap; }
    .social-card .icon { width: 64px; height: 64px; border-radius: 12px; border: 1px solid #dbe2ee; background: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden; font-weight: 600; color: #1b263b; }
    .social-card .icon img { width: 100%; height: 100%; object-fit: cover; }
    .social-card .fields { flex: 1; display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .social-card .fields label { display: flex; flex-direction: column; gap: 6px; font-size: 0.85rem; }
    .social-card .fields input { padding: 8px 10px; border-radius: 8px; border: 1px solid #dbe2ee; font: inherit; }
    .social-card .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    @media (max-width: 760px) {
      body { padding: 16px; }
      .branding-card, .hero-card { flex-direction: column; }
      .hero-preview { width: 100%; }
      .theme-controls { grid-template-columns: 1fr; }
      .social-card { flex-direction: column; align-items: stretch; }
      .social-card .icon { align-self: flex-start; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <h1>Admin panel</h1>
      <a class="link-back" href="/">&larr; Back to hub</a>
    </header>

    <section>
      <h2>Site branding</h2>
      <div class="branding-card">
        <img id="siteLogoPreview" src="/static/logo1.svg" alt="Site logo">
        <div class="controls">
          <label class="inline">
            Site title
            <input type="text" id="siteTitleInput" placeholder="Linart Systems">
          </label>
          <label class="inline">
            Tagline
            <textarea id="brandTaglineInput" placeholder="Central hub running inside a container. Access every service from one place."></textarea>
          </label>
          <div class="theme-controls">
            <label class="inline">
              Page background
              <input type="color" id="pageBackgroundColorInput" value="#05060b">
            </label>
            <label class="inline">
              Card color
              <input type="color" id="surfaceColorInput" value="#0c1820">
            </label>
            <div class="theme-slider">
              <label class="inline" style="flex:1;">
                Background opacity
                <input type="range" id="pageBackgroundOpacityInput" min="0" max="100" step="1" value="100">
              </label>
              <strong id="pageBackgroundOpacityValue">100%</strong>
            </div>
            <div class="theme-slider">
              <label class="inline" style="flex:1;">
                Card opacity
                <input type="range" id="surfaceOpacityInput" min="0" max="100" step="1" value="72">
              </label>
              <strong id="surfaceOpacityValue">72%</strong>
            </div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <label class="button">Upload logo<input type="file" id="siteLogoFile" accept="image/*"></label>
            <button type="button" class="secondary" id="siteLogoReset">Reset to default</button>
            <button type="button" id="saveBranding">Save changes</button>
          </div>
          <div class="hint">Accepted formats: PNG, JPG, SVG, GIF, WEBP. Max 5&nbsp;MB. Colors update the public landing page background and info cards.</div>
        </div>
      </div>
    </section>

    <section>
      <h2>Welcome hero</h2>
      <div class="hero-card">
        <div class="hero-preview">
          <span class="badge-small">Background video</span>
          <video id="heroVideoPreview" controls muted loop playsinline></video>
          <div class="hint">If no video is uploaded, a static gradient is shown.</div>
        </div>
        <div class="hero-controls">
          <label class="inline">
            Intro title
            <input type="text" id="introTitleInput" placeholder="Welcome to my server!">
          </label>
          <label class="inline">
            Intro message
            <textarea id="introBodyInput" placeholder="Tell visitors who you are and what this hub does."></textarea>
          </label>
        <label class="inline">
          WhatsApp number
          <input type="text" id="whatsappInput" placeholder="+49123456789">
        </label>
        <label class="inline">
          Overlay color
          <input type="color" id="heroOverlayColorInput" value="#05060b">
        </label>
        <div class="hero-slider">
          <label class="inline" style="flex:1;">
            Overlay opacity
            <input type="range" id="heroOverlayOpacityInput" min="0" max="100" step="1" value="85">
          </label>
          <strong id="heroOverlayOpacityValue">85%</strong>
        </div>
        <div class="hero-slider">
          <label class="inline" style="flex:1;">
            Video blur
            <input type="range" id="heroBlurInput" min="0" max="40" step="1">
          </label>
            <strong id="heroBlurValue">0</strong>
          </div>
          <div class="welcome-controls">
            <div class="welcome-thumb" id="welcomeImageThumb">
              <img id="welcomeImagePreview" alt="Welcome image preview" class="welcome-image is-hidden">
              <span class="placeholder">No image</span>
            </div>
            <div class="welcome-actions">
              <label class="button">Upload welcome image<input type="file" id="welcomeImageFile" accept="image/*"></label>
              <button type="button" class="secondary" id="welcomeImageRemove">Remove image</button>
            </div>
          </div>
          <div class="hint">Shown next to the intro text. Recommended square image up to 5&nbsp;MB.</div>
          <div class="hero-buttons">
            <label class="button">Upload hero video<input type="file" id="heroVideoFile" accept="video/mp4,video/webm,video/ogg"></label>
            <button type="button" class="secondary" id="heroVideoRemove">Remove video</button>
            <button type="button" id="saveHero">Save hero</button>
          </div>
          <div class="hint">Recommended: MP4/WebM up to ~50&nbsp;MB. Video plays muted, loops, and is blurred using the value above.</div>
        </div>
      </div>
    </section>

    <section>
      <h2>Services</h2>
      <div id="servicesList" class="services-grid"></div>
    </section>

    <section>
      <h3>Add service</h3>
      <form id="add">
        <label>
          Name (ID)
          <input name="name" type="text" placeholder="service3" required>
        </label>
        <label>
          Display name
          <input name="displayName" type="text" placeholder="My new service">
        </label>
        <label>
          Description
          <input name="description" type="text" placeholder="What this service does">
        </label>
        <label>
          Target URL
          <input name="target" type="url" placeholder="http://service3:3002" required>
        </label>
        <label>
          Prefix
          <input name="prefix" type="text" placeholder="/service3">
        </label>
        <label>
          Logo URL
          <input name="logo" type="text" placeholder="/static/uploads/service3.png">
        </label>
        <label class="button">
          Upload logo
          <input type="file" id="addLogoFile" accept="image/*">
        </label>
        <div class="form-actions">
          <button type="submit">Add service</button>
          <span class="hint">Upload file to autofill logo URL or paste an existing path.</span>
        </div>
      </form>
    </section>

    <section>
      <h2>User accounts</h2>
      <div id="usersList" class="services-grid"></div>
      <form id="addUser" class="card-form">
        <label>
          Username
          <input type="text" id="newUserName" placeholder="operator1" required>
        </label>
        <label>
          Password
          <input type="password" id="newUserPassword" placeholder="Min 4 chars" minlength="4" required>
        </label>
        <label class="inline" style="gap:8px;">
          <input type="checkbox" id="newUserAllowAll" checked>
          Allow all services
        </label>
        <div id="newUserServices" class="service-checkboxes"></div>
        <div class="form-actions">
          <button type="submit">Add user</button>
        </div>
      </form>
      <div class="hint">Users are handled by the hub only. The superadmin account remains "admin".</div>
    </section>

    <section>
      <h2>Footer social links</h2>
      <div id="socialList" class="social-list"></div>
      <form id="addSocial" class="card-form">
        <label class="inline">
          Label
          <input type="text" id="newSocialLabel" placeholder="Twitter" required>
        </label>
        <label class="inline">
          URL
          <input type="url" id="newSocialUrl" placeholder="https://twitter.com/linart" required>
        </label>
        <div class="full">
          <label class="button">Upload icon<input type="file" id="addSocialIconFile" accept="image/*"></label>
          <button type="submit">Add link</button>
          <span class="hint">Upload SVG or PNG (square, up to 2&nbsp;MB). Leave blank to use initials.</span>
        </div>
      </form>
    </section>

    <section>
      <h2>Security</h2>
      <form id="passwordForm" class="card-form">
        <label class="inline">
          Current password
          <input type="password" id="currentPasswordInput" required>
        </label>
        <label class="inline">
          New password
          <input type="password" id="newPasswordInput" minlength="6" required>
        </label>
        <label class="inline">
          Confirm password
          <input type="password" id="confirmPasswordInput" minlength="6" required>
        </label>
        <div class="full">
          <button type="submit">Change password</button>
          <span class="hint">Minimum 6 characters. Session will stay active after change.</span>
          <span id="passwordStatus"></span>
        </div>
      </form>
    </section>
  </div>

  <script>
    const state = {
      config: {
        siteLogo: '/static/logo1.svg',
        siteTitle: 'Linart Systems',
        brandTagline: 'Central hub running inside a container. Access every service from one place.',
        introTitle: '',
        introBody: '',
        contactWhatsapp: '',
        heroVideo: '',
        heroVideoBlur: 8,
        heroOverlayColor: '#05060b',
        heroOverlayOpacity: 0.85,
        surfaceColor: '#0c1820',
        surfaceOpacity: 0.72,
        pageBackgroundColor: '#05060b',
        pageBackgroundOpacity: 1,
        welcomeImage: '',
        socialLinks: [],
      },
      services: [],
      users: []
    };

    function handleError(error) {
      console.error(error);
      alert(error.message || 'Unexpected error');
    }

    async function fetchJson(url, options) {
      const response = await fetch(url, options);
      const data = await response.json().catch(() => ({}));
      if (!response.ok || (data && data.ok === false)) {
        throw new Error((data && data.error) || response.statusText || 'Request failed');
      }
      return data;
    }

    async function uploadAsset(file) {
      const form = new FormData();
      form.append('logo', file);
      const data = await fetchJson('/admin/upload-logo', { method: 'POST', body: form });
      return data.path;
    }

    const siteLogoPreview = document.getElementById('siteLogoPreview');
    const siteTitleInput = document.getElementById('siteTitleInput');
    const brandTaglineInput = document.getElementById('brandTaglineInput');
    const pageBackgroundColorInput = document.getElementById('pageBackgroundColorInput');
    const pageBackgroundOpacityInput = document.getElementById('pageBackgroundOpacityInput');
    const pageBackgroundOpacityValue = document.getElementById('pageBackgroundOpacityValue');
    const surfaceColorInput = document.getElementById('surfaceColorInput');
    const surfaceOpacityInput = document.getElementById('surfaceOpacityInput');
    const surfaceOpacityValue = document.getElementById('surfaceOpacityValue');
    const heroVideoPreview = document.getElementById('heroVideoPreview');
    const heroVideoFile = document.getElementById('heroVideoFile');
    const heroVideoRemove = document.getElementById('heroVideoRemove');
    const introTitleInput = document.getElementById('introTitleInput');
    const introBodyInput = document.getElementById('introBodyInput');
    const whatsappInput = document.getElementById('whatsappInput');
    const heroOverlayColorInput = document.getElementById('heroOverlayColorInput');
    const heroOverlayOpacityInput = document.getElementById('heroOverlayOpacityInput');
    const heroOverlayOpacityValue = document.getElementById('heroOverlayOpacityValue');
    const heroBlurInput = document.getElementById('heroBlurInput');
    const heroBlurValue = document.getElementById('heroBlurValue');
    const welcomeImageThumb = document.getElementById('welcomeImageThumb');
    const welcomeImagePreview = document.getElementById('welcomeImagePreview');
    const welcomeImagePlaceholder = welcomeImageThumb.querySelector('.placeholder');
    const welcomeImageFile = document.getElementById('welcomeImageFile');
    const welcomeImageRemove = document.getElementById('welcomeImageRemove');
    const servicesList = document.getElementById('servicesList');
    const usersList = document.getElementById('usersList');
    const addUserForm = document.getElementById('addUser');
    const newUserNameInput = document.getElementById('newUserName');
    const newUserPasswordInput = document.getElementById('newUserPassword');
    const newUserAllowAll = document.getElementById('newUserAllowAll');
    const newUserServices = document.getElementById('newUserServices');
    const socialList = document.getElementById('socialList');
    const addSocialForm = document.getElementById('addSocial');
    const newSocialLabelInput = document.getElementById('newSocialLabel');
    const newSocialUrlInput = document.getElementById('newSocialUrl');
    const addSocialIconFile = document.getElementById('addSocialIconFile');
    const passwordStatus = document.getElementById('passwordStatus');

    pageBackgroundOpacityInput.value = 100;
    pageBackgroundOpacityValue.textContent = '100%';
    heroBlurInput.value = 8;
    heroBlurValue.textContent = '8';
    surfaceOpacityValue.textContent = surfaceOpacityInput.value + '%';

    function renderBranding() {
      siteLogoPreview.src = state.config.siteLogo || '/static/logo1.svg';
      siteTitleInput.value = state.config.siteTitle || '';
      brandTaglineInput.value = state.config.brandTagline || '';

      const pageColor =
        typeof state.config.pageBackgroundColor === 'string' && state.config.pageBackgroundColor
          ? state.config.pageBackgroundColor
          : '#05060b';
      pageBackgroundColorInput.value = pageColor;

      const pageOpacity = Number.isFinite(Number(state.config.pageBackgroundOpacity))
        ? Math.max(0, Math.min(1, Number(state.config.pageBackgroundOpacity)))
        : 1;
      const pageOpacityPercent = Math.round(pageOpacity * 100);
      pageBackgroundOpacityInput.value = pageOpacityPercent;
      pageBackgroundOpacityValue.textContent = pageOpacityPercent + '%';
      const surfaceColor =
        typeof state.config.surfaceColor === 'string' && state.config.surfaceColor
          ? state.config.surfaceColor
          : '#0c1820';
      surfaceColorInput.value = surfaceColor;

      const surfaceOpacity = Number.isFinite(Number(state.config.surfaceOpacity))
        ? Math.max(0, Math.min(1, Number(state.config.surfaceOpacity)))
        : 0.72;
      const surfaceOpacityPercent = Math.round(surfaceOpacity * 100);
      surfaceOpacityInput.value = surfaceOpacityPercent;
      surfaceOpacityValue.textContent = surfaceOpacityPercent + '%';
    }

    function renderHero() {
      introTitleInput.value = state.config.introTitle || '';
      introBodyInput.value = state.config.introBody || '';
      whatsappInput.value = state.config.contactWhatsapp || '';

      heroOverlayColorInput.value = state.config.heroOverlayColor || '#05060b';
      const overlayOpacity = Number.isFinite(Number(state.config.heroOverlayOpacity))
        ? Math.max(0, Math.min(1, Number(state.config.heroOverlayOpacity)))
        : 0.85;
      heroOverlayOpacityInput.value = Math.round(overlayOpacity * 100);
      heroOverlayOpacityValue.textContent = heroOverlayOpacityInput.value + '%';

      heroBlurInput.value = Number.isFinite(Number(state.config.heroVideoBlur))
        ? Number(state.config.heroVideoBlur)
        : 8;
      heroBlurValue.textContent = heroBlurInput.value;

      if (state.config.heroVideo) {
        heroVideoPreview.src = state.config.heroVideo;
        heroVideoPreview.classList.remove('is-hidden');
        heroVideoPreview.load();
      } else {
        heroVideoPreview.removeAttribute('src');
        heroVideoPreview.classList.add('is-hidden');
        heroVideoPreview.load();
      }

      setWelcomeImagePreview(state.config.welcomeImage);
    }

    function setWelcomeImagePreview(src) {
      if (src) {
        welcomeImagePreview.src = src;
        welcomeImagePreview.classList.remove('is-hidden');
        welcomeImagePlaceholder.style.display = 'none';
      } else {
        welcomeImagePreview.classList.add('is-hidden');
        welcomeImagePreview.removeAttribute('src');
        welcomeImagePlaceholder.style.display = 'block';
      }
    }

    function buildMeta(label, value) {
      const el = document.createElement('div');
      el.className = 'meta';
      el.textContent = `${label}: ${value}`;
      return el;
    }

    function renderServices() {
      servicesList.innerHTML = '';
      if (!state.services.length) {
        const empty = document.createElement('div');
        empty.className = 'meta';
        empty.textContent = 'No services registered yet.';
        servicesList.appendChild(empty);
        return;
      }

      state.services.forEach((service) => {
        const card = document.createElement('div');
        card.className = 'service-card';

        const logo = document.createElement('img');
        logo.src = service.logo || state.config.siteLogo || '/static/logo1.svg';
        logo.alt = `${service.displayName || service.name} logo`;
        card.appendChild(logo);

        const info = document.createElement('div');
        info.className = 'info';
        const title = document.createElement('strong');
        title.textContent = `${service.displayName || service.name} (${service.name})`;
        info.appendChild(title);
        if (service.description) {
          info.appendChild(buildMeta('Description', service.description));
        }
        info.appendChild(buildMeta('Target', service.target));
        info.appendChild(buildMeta('Prefix', service.prefix));
        card.appendChild(info);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const uploadLabel = document.createElement('label');
        uploadLabel.className = 'button';
        uploadLabel.textContent = 'Upload logo';
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        uploadLabel.appendChild(fileInput);
        fileInput.addEventListener('change', async (event) => {
          if (!event.target.files?.length) return;
          try {
            const path = await uploadAsset(event.target.files[0]);
            await fetchJson(`/admin/services/${encodeURIComponent(service.name)}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ logo: path })
            });
            await loadAll();
          } catch (error) {
            handleError(error);
          } finally {
            event.target.value = '';
          }
        });
        actions.appendChild(uploadLabel);

        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'secondary';
        clearBtn.textContent = 'Remove logo';
        clearBtn.addEventListener('click', async () => {
          try {
            await fetchJson(`/admin/services/${encodeURIComponent(service.name)}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ logo: '' })
            });
            await loadAll();
          } catch (error) {
            handleError(error);
          }
        });
        actions.appendChild(clearBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', async () => {
          if (!confirm(`Delete service "${service.name}"?`)) return;
          try {
            await fetchJson(`/admin/services/${encodeURIComponent(service.name)}`, { method: 'DELETE' });
            await loadAll();
          } catch (error) {
            handleError(error);
          }
        });
        actions.appendChild(deleteBtn);

        card.appendChild(actions);
        servicesList.appendChild(card);
      });
    }


    function renderServiceCheckboxes(container, selectedSet = new Set(), disabled = false) {
      if (!container) return;
      container.innerHTML = '';
      const services = Array.isArray(state.services) ? state.services : [];
      if (!services.length) {
        const empty = document.createElement('div');
        empty.className = 'meta';
        empty.textContent = 'No services registered.';
        container.appendChild(empty);
        return;
      }
      services.forEach((service) => {
        const label = document.createElement('label');
        label.className = 'inline';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.dataset.serviceId = service.name;
        input.checked = selectedSet.has(service.name);
        input.disabled = disabled;
        label.appendChild(input);
        label.appendChild(document.createTextNode(` ${service.displayName || service.name}`));
        container.appendChild(label);
      });
    }

    function renderUsers() {
      usersList.innerHTML = '';
      const users = Array.isArray(state.users) ? state.users : [];
      if (!users.length) {
        const empty = document.createElement('div');
        empty.className = 'meta';
        empty.textContent = 'No users yet.';
        usersList.appendChild(empty);
        return;
      }

      users.forEach((user) => {
        const card = document.createElement('div');
        card.className = 'service-card';
        const info = document.createElement('div');
        info.className = 'info';
        const title = document.createElement('strong');
        title.textContent = user.username;
        info.appendChild(title);
        const allowed = Array.isArray(user.allowedServices) && user.allowedServices.length
          ? user.allowedServices.join(', ')
          : 'All services';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = 'Allowed: ' + allowed;
        info.appendChild(meta);
        card.appendChild(info);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const allowAllWrap = document.createElement('label');
        allowAllWrap.className = 'inline';
        const allowAllInput = document.createElement('input');
        allowAllInput.type = 'checkbox';
        allowAllInput.checked = !user.allowedServices || !user.allowedServices.length;
        allowAllWrap.appendChild(allowAllInput);
        allowAllWrap.appendChild(document.createTextNode(' Allow all services'));
        actions.appendChild(allowAllWrap);

        const servicesBox = document.createElement('div');
        servicesBox.className = 'service-checkboxes';
        renderServiceCheckboxes(servicesBox, new Set(user.allowedServices || []), allowAllInput.checked);
        allowAllInput.addEventListener('change', () => {
          const disable = allowAllInput.checked;
          servicesBox.querySelectorAll('input[type="checkbox"][data-service-id]').forEach((cb) => {
            cb.disabled = disable;
          });
        });
        actions.appendChild(servicesBox);

        const passwordInput = document.createElement('input');
        passwordInput.type = 'password';
        passwordInput.placeholder = 'New password (optional)';
        passwordInput.minLength = 4;
        actions.appendChild(passwordInput);

        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', async () => {
          try {
            const payload = {};
            if (allowAllInput.checked) {
              payload.allowedServices = [];
            } else {
              const selected = Array.from(
                servicesBox.querySelectorAll('input[type="checkbox"][data-service-id]:checked')
              ).map((el) => el.dataset.serviceId);
              payload.allowedServices = selected;
            }
            if (passwordInput.value && passwordInput.value.length >= 4) {
              payload.password = passwordInput.value;
            }
            await fetchJson(`/admin/users/${encodeURIComponent(user.username)}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            passwordInput.value = '';
            await loadAll();
          } catch (error) {
            handleError(error);
          }
        });
        actions.appendChild(saveBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', async () => {
          if (!confirm(`Delete user "${user.username}"?`)) return;
          try {
            await fetchJson(`/admin/users/${encodeURIComponent(user.username)}`, { method: 'DELETE' });
            await loadAll();
          } catch (error) {
            handleError(error);
          }
        });
        actions.appendChild(deleteBtn);

        card.appendChild(actions);
        usersList.appendChild(card);
      });
    }

    function renderNewUserServices() {
      if (!newUserServices) return;
      const selected = new Set();
      const disable = newUserAllowAll ? newUserAllowAll.checked : false;
      renderServiceCheckboxes(newUserServices, selected, disable);
      if (newUserAllowAll) {
        newUserAllowAll.addEventListener('change', () => {
          const shouldDisable = newUserAllowAll.checked;
          newUserServices.querySelectorAll('input[type="checkbox"][data-service-id]').forEach((cb) => {
            cb.disabled = shouldDisable;
          });
        });
      }
    }

    function renderSocialLinks() {
      socialList.innerHTML = '';

      const links = Array.isArray(state.config.socialLinks) ? state.config.socialLinks : [];
      if (!links.length) {
        const empty = document.createElement('div');
        empty.className = 'meta';
        empty.textContent = 'No social links configured.';
        socialList.appendChild(empty);
        return;
      }

      links.forEach((link) => {
        const card = document.createElement('div');
        card.className = 'social-card';

        const icon = document.createElement('div');
        icon.className = 'icon';
        if (link.icon) {
          const img = document.createElement('img');
          img.src = link.icon;
          img.alt = `${link.label} icon`;
          icon.appendChild(img);
        } else {
          icon.textContent = (link.label || '?').trim().charAt(0).toUpperCase() || '?';
        }
        card.appendChild(icon);

        const fields = document.createElement('div');
        fields.className = 'fields';

        const labelField = document.createElement('label');
        labelField.textContent = 'Label';
        const labelInput = document.createElement('input');
        labelInput.type = 'text';
        labelInput.value = link.label || '';
        labelField.appendChild(labelInput);
        fields.appendChild(labelField);

        const urlField = document.createElement('label');
        urlField.textContent = 'URL';
        const urlInput = document.createElement('input');
        urlInput.type = 'url';
        urlInput.value = link.url || '';
        urlField.appendChild(urlInput);
        fields.appendChild(urlField);

        card.appendChild(fields);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.textContent = 'Save';
        saveBtn.addEventListener('click', async () => {
          const label = labelInput.value.trim();
          const url = urlInput.value.trim();
          if (!label || !url) {
            alert('Label and URL are required.');
            return;
          }
          try {
            await fetchJson(`/admin/social-links/${encodeURIComponent(link.id)}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ label, url })
            });
            await loadAll();
          } catch (error) {
            handleError(error);
          }
        });
        actions.appendChild(saveBtn);

        const uploadLabel = document.createElement('label');
        uploadLabel.className = 'button';
        uploadLabel.textContent = 'Upload icon';
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        uploadLabel.appendChild(fileInput);
        fileInput.addEventListener('change', async (event) => {
          if (!event.target.files?.length) return;
          try {
            const path = await uploadAsset(event.target.files[0]);
            await fetchJson(`/admin/social-links/${encodeURIComponent(link.id)}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ icon: path })
            });
            await loadAll();
          } catch (error) {
            handleError(error);
          } finally {
            event.target.value = '';
          }
        });
        actions.appendChild(uploadLabel);

        const removeIconBtn = document.createElement('button');
        removeIconBtn.type = 'button';
        removeIconBtn.className = 'secondary';
        removeIconBtn.textContent = 'Remove icon';
        removeIconBtn.addEventListener('click', async () => {
          try {
            await fetchJson(`/admin/social-links/${encodeURIComponent(link.id)}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ icon: '' })
            });
            await loadAll();
          } catch (error) {
            handleError(error);
          }
        });
        actions.appendChild(removeIconBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', async () => {
          if (!confirm(`Delete link "${link.label}"?`)) return;
          try {
            await fetchJson(`/admin/social-links/${encodeURIComponent(link.id)}`, { method: 'DELETE' });
            await loadAll();
          } catch (error) {
            handleError(error);
          }
        });
        actions.appendChild(deleteBtn);

        card.appendChild(actions);
        socialList.appendChild(card);
      });
    }

    async function loadAll() {
      try {
        const [services, config, usersResp] = await Promise.all([
          fetchJson('/admin/services'),
          fetchJson('/admin/config'),
          fetchJson('/admin/users')
        ]);
        state.services = services;
        state.config = config;
        state.users = usersResp && usersResp.users ? usersResp.users : [];
        renderBranding();
        renderHero();
        renderServices();
        renderNewUserServices();
        renderUsers();
        renderSocialLinks();
      } catch (error) {
        handleError(error);
      }
    }

    if (addUserForm) {
      addUserForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!newUserNameInput || !newUserPasswordInput) return;
        const username = newUserNameInput.value.trim();
        const password = newUserPasswordInput.value;
        const allowAll = newUserAllowAll && newUserAllowAll.checked;
        const selectedServices = allowAll || !newUserServices
          ? []
          : Array.from(
              newUserServices.querySelectorAll('input[type="checkbox"][data-service-id]:checked')
            ).map((el) => el.dataset.serviceId);
        if (!username || !password) {
          handleError(new Error('Username and password are required'));
          return;
        }
        try {
          await fetchJson('/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, allowedServices: selectedServices })
          });
          newUserPasswordInput.value = '';
          if (newUserServices) {
            newUserServices.querySelectorAll('input[type="checkbox"][data-service-id]').forEach((cb) => (cb.checked = false));
          }
          if (newUserAllowAll) newUserAllowAll.checked = true;
          await loadAll();
        } catch (error) {
          handleError(error);
        }
      });
    }

    document.getElementById('saveBranding').addEventListener('click', async () => {
      try {
        const payload = {
          siteTitle: siteTitleInput.value.trim(),
          brandTagline: brandTaglineInput.value.trim(),
          pageBackgroundColor: pageBackgroundColorInput.value,
          pageBackgroundOpacity: Number(pageBackgroundOpacityInput.value) / 100,
          surfaceColor: surfaceColorInput.value,
          surfaceOpacity: Number(surfaceOpacityInput.value) / 100
        };
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    document.getElementById('siteLogoReset').addEventListener('click', async () => {
      if (!confirm('Reset site logo to default?')) return;
      try {
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ siteLogo: '' })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    document.getElementById('siteLogoFile').addEventListener('change', async (event) => {
      if (!event.target.files?.length) return;
      try {
        const path = await uploadAsset(event.target.files[0]);
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ siteLogo: path })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      } finally {
        event.target.value = '';
      }
    });

    pageBackgroundOpacityInput.addEventListener('input', () => {
      pageBackgroundOpacityValue.textContent = pageBackgroundOpacityInput.value + '%';
    });
    surfaceOpacityInput.addEventListener('input', () => {
      surfaceOpacityValue.textContent = surfaceOpacityInput.value + '%';
    });

    welcomeImageFile.addEventListener('change', async (event) => {
      if (!event.target.files?.length) return;
      const file = event.target.files[0];
      try {
        const path = await uploadAsset(file);
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ welcomeImage: path })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      } finally {
        event.target.value = '';
      }
    });

    welcomeImageRemove.addEventListener('click', async () => {
      if (!state.config.welcomeImage) return;
      try {
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ welcomeImage: '' })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    heroOverlayOpacityInput.addEventListener('input', () => {
      heroOverlayOpacityValue.textContent = heroOverlayOpacityInput.value + '%';
    });

    heroBlurInput.addEventListener('input', () => {
      heroBlurValue.textContent = heroBlurInput.value;
    });

    document.getElementById('saveHero').addEventListener('click', async () => {
      try {
        const payload = {
          introTitle: introTitleInput.value.trim(),
          introBody: introBodyInput.value.trim(),
          contactWhatsapp: whatsappInput.value.trim(),
          heroOverlayColor: heroOverlayColorInput.value,
          heroOverlayOpacity: Number(heroOverlayOpacityInput.value) / 100,
          heroVideoBlur: Number(heroBlurInput.value)
        };
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    heroVideoFile.addEventListener('change', async (event) => {
      if (!event.target.files?.length) return;
      const file = event.target.files[0];
      try {
        const path = await uploadAsset(file);
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ heroVideo: path })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      } finally {
        event.target.value = '';
      }
    });

    heroVideoRemove.addEventListener('click', async () => {
      if (!state.config.heroVideo) return;
      if (!confirm('Remove the current hero video?')) return;
      try {
        await fetchJson('/admin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ heroVideo: '' })
        });
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    addSocialForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const label = newSocialLabelInput.value.trim();
      const url = newSocialUrlInput.value.trim();
      if (!label || !url) {
        alert('Label and URL are required.');
        return;
      }

      try {
        let iconPath = '';
        if (addSocialIconFile.files?.length) {
          iconPath = await uploadAsset(addSocialIconFile.files[0]);
        }

        await fetchJson('/admin/social-links', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label, url, icon: iconPath })
        });

        addSocialForm.reset();
        addSocialIconFile.value = '';
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    document.getElementById('add').addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = event.target;
      const fd = new FormData(form);
      const payload = {
        name: fd.get('name'),
        displayName: fd.get('displayName'),
        description: fd.get('description'),
        target: fd.get('target'),
        prefix: fd.get('prefix'),
        logo: fd.get('logo')
      };

      const fileInput = document.getElementById('addLogoFile');
      try {
        if (fileInput.files?.length) {
          payload.logo = await uploadAsset(fileInput.files[0]);
        }

        Object.keys(payload).forEach((key) => {
          if (typeof payload[key] === 'string') {
            const trimmed = payload[key].trim();
            payload[key] = trimmed || undefined;
          }
          if (payload[key] === undefined) {
            delete payload[key];
          }
        });

        await fetchJson('/admin/services', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        form.reset();
        if (fileInput) fileInput.value = '';
        await loadAll();
      } catch (error) {
        handleError(error);
      }
    });

    document.getElementById('passwordForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      passwordStatus.textContent = '';
      passwordStatus.className = '';

      const currentPassword = document.getElementById('currentPasswordInput').value;
      const newPassword = document.getElementById('newPasswordInput').value;
      const confirmPassword = document.getElementById('confirmPasswordInput').value;

      if (newPassword !== confirmPassword) {
        passwordStatus.textContent = 'Passwords do not match.';
        passwordStatus.className = 'status-error';
        return;
      }

      try {
        await fetchJson('/admin/password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword })
        });
        passwordStatus.textContent = 'Password updated.';
        passwordStatus.className = 'status-success';
        event.target.reset();
      } catch (error) {
        passwordStatus.textContent = error.message || 'Failed to update password.';
        passwordStatus.className = 'status-error';
      }
    });

    loadAll();
  </script>
</body>
</html>



