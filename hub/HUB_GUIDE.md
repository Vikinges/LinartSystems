# Linart Hub – Developer Guide

Эта заметка описывает как устроен главный сайт (`hub/`), как он взаимодействует с остальными контейнерами и какие шаги нужны, чтобы локально или на сервере всё запустить и расширить.

## Архитектура

- **Traefik (`reverse-proxy`)** – единственная точка входа. Слушает 80/443, запрашивает сертификат Let’s Encrypt (для production) и маршрутизирует запросы по домену `linart.club`.
- **Hub (этот проект)** – Node.js/Express, работает на `8080` внутри сети compose. Отдаёт статику (`/static`), API `/api/status`, `/admin` и проксирует сервисы через `http-proxy-middleware`.
- **Сервисы** (`service1`, `service2`, …) – независимые приложения, которые Hub регистрирует и отображает на главной. Для новых сервисов достаточно запустить их контейнеры и добавить запись через админку.
- Все контейнеры объединены одной docker-compose сетью, поэтому Hub умеет ходить к сервисам по их имени (`http://service1:3000`, `http://service2:3001` и т.д.).

## Важные моменты

### Обращение к сайту

- В production Traefik выдаёт валидный сертификат для `linart.club`. Все публичные ссылки и редиректы рассчитаны именно на этот домен.
- В локальной среде:
  1. добавьте строку `127.0.0.1 linart.club` в `hosts` (от имени администратора);
  2. запустите `docker-compose up -d --build` – Traefik, Hub и сервисы поднимутся;
  3. открывайте `https://linart.club/`. Браузер предупредит о самоподписанном сертификате – подтверждайте «Advanced → Continue»;
  4. если Chrome запомнил HSTS, удалите запись на `chrome://net-internals/#hsts`.

### Health-check и API

- Hub имеет хелсчек `GET /health` – на него смотрит Docker (`CMD-SHELL wget -q -O - http://localhost:8080/health || exit 1`). Аналогично сервисы реализуют `GET /health` на своих портах.
- Основное API:
  - `GET /api/status` – Hub собирает информацию о зарегистрированных сервисах и отдаёт: список сервисов (с результатами обращений к `/health`) и объект `hub` с текущими настройками (логотип, приветствие, видео и т.п.).
  - `/admin/*` – панель управления (нужен пароль). Обрабатывает загрузку файлов, изменение текста, добавление сервисов.
  - `/service1/*`, `/service2/*`, … – прокси до сервисов. Записи `/service1` и `/service2` редиректят на `/service1/` и `/service2/`, чтобы относительные пути внутри сервисов работали корректно.

## Панель администрирования

Пароль хранится в `hub/admin.json` (bcrypt-хеш). По умолчанию из конфигурации (`HUB_ADMIN_PASSWORD` или значение «admin»). Через раздел **Security** можно этот пароль сменить.

Основные разделы:

- **Site branding** – логотип и заголовок. Загрузка логотипа обновляет `siteLogo` и переиспользуется на главной и в списке сервисов.
- **Welcome hero** – приветствие, текст, WhatsApp-номер, фоновое видео и параметры блюра/оверлея.
- **Services** – список зарегистрированных сервисов. Можно менять логотипы, удалять запись, либо добавить новый сервис (Name/Target/Prefix/Description) – после сохранения он появится на главной.

Все настройки сохраняются в `hub/config.json` (см. `.gitignore` – файл не коммитится, на сервере должен существовать). При запуске Hub загружает файл; при отсутствии – создаёт со значениями по умолчанию.

Загрузка файлов (`/admin/upload-logo`) принимает изображения `png/jpg/jpeg/svg/gif/webp` и видео `mp4/webm/ogv` (до 50MB). Файлы складываются в `hub/static/uploads/` и обновляются в конфиге ссылками вида `/static/uploads/<name>`.

## Добавление нового сервиса (пример «Service 3»)

1. Подготовить приложение (Express, React, etc.) и Dockerfile, аналогично `service1/` или `service2/`.
2. Дописать его секцию в `docker-compose.yml`, чтобы контейнер стартовал вместе с остальными (порт наружу можно не публиковать – достаточно внутреннего).
3. `docker-compose up -d --build` – сервис запустится внутри сети.
4. Зайти в `/admin`, в блоке **Add service** заполнить поля:
   - Name (ID) – например `service3`;
   - Target URL – `http://service3:3002` (или порт, который слушает новый сервис внутри контейнера);
   - Prefix – `/service3` (Hub будет проксировать `/service3/...`);
   - при желании указать описание и логотип.
5. После сохранения сервис появится на главной и попадёт в `/api/status`. Если впоследствии хотите удалить – нажмите «Delete» рядом с ним в админке.

## Локальная проверка

```powershell
git pull
docker-compose up -d --build
docker-compose ps   # все 4 контейнера должны быть Up (healthy)
```

Затем `https://linart.club/` (или `http://linart.club/` если хотите без TLS). Через админку загрузить логотип/видео – файлы сразу доступны в `/static/uploads/` (на странице обновление произойдёт после следующего запроса `GET /api/status`).

## Продакшен (сервер)

На сервере шаги те же: `git pull`, `docker-compose up -d --build`. Traefik запросит Let’s Encrypt сертификат (убедитесь, что домен указывает на сервер и 80/443 открыты). `hub/admin.json`, `hub/static/uploads/` и `traefik/letsencrypt/acme.json` не должны коммититься – это рабочие артефакты.

---

Надеюсь, эта шпаргалка поможет быстро разобраться с устройством Hub и при необходимости добавить новые микросервисы по аналогии с `service1`/`service2`. Если планируется дополнительный сервис, достаточно повторить шаги из секции «Добавление нового сервиса» и перезапустить compose. Удачи!
