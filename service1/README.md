# PDF Preventative Maintenance Form Service

A turnkey Node.js service that reads an AcroForm PDF template, generates a matching web form, accepts text and image submissions, fills the PDF, embeds photos, flattens the result, and serves downloadable checklists.

## Prerequisites

- Node.js 20+ (for `node --watch` and modern ES features)
- npm 8+
- Access to the template PDF at `TEMPLATE_PATH` (defaults to `/mnt/data/SNDS-LED-Preventative-Maintenance-Checklist BER Blanko.pdf`)

## Installation

```bash
npm install
```

Copy `.env.example` to `.env` and adjust paths and port if needed:

```bash
cp .env.example .env
# edit TEMPLATE_PATH if your PDF lives elsewhere
```

## Extract AcroForm fields

Run the extractor once the PDF is available. It prints field metadata to the console and writes `fields.json`.

```bash
npm run extract-fields
```

On success you will see JSON output and `fields.json` will contain field names, types, and the template path. If the PDF cannot be found the script exits with a non-zero status and an explanatory error.

## Mapping request fields

`mapping.json` (optional) lets you override the request field names for each AcroForm key. Example:

```json
{
  "End customer name": "end_customer_name",
  "Site location": "site_location"
}
```

If an entry is missing, the request field name defaults to the AcroForm field name.

## Start the server

```bash
npm start
```

By default the server listens on `PORT` (3000) and regenerates `public/index.html` on startup so the mobile-friendly form always mirrors the fields described in `fields.json`.

When a submission succeeds it writes the filled PDF to `out/filled-<timestamp>.pdf`, emits matching metadata to `out/filled-<timestamp>.json`, and returns a JSON payload with a download URL.

### Development mode

```bash
npm run dev
```

This runs `node --watch server.js` for quick feedback during development.

## Test submission (cURL)

After starting the server, execute the following (adjust paths to real JPEG/PNG images):

```bash
curl -X POST "http://localhost:3000/submit" \
  -F "end_customer_name=ACME" \
  -F "site_location=Berlin" \
  -F "date_of_service=2025-09-30" \
  -F "check10=on" \
  -F "submitter_name=Ivan" \
  -F "photos[]=@/path/photo1.jpg" \
  -F "photos[]=@/path/photo2.jpg"
```

The response body will include `{ "ok": true, "url": "http://localhost:3000/download/..." }` on success.

## Smoke test script

`test-start.sh` automates the main flow:

1. Verifies the template exists.
2. Runs `npm run extract-fields`.
3. Confirms `fields.json` was generated.
4. Launches the server, provides the cURL command, and waits for user input (or runs cURL automatically when `TEST_PHOTO1`/`TEST_PHOTO2` are set).

```bash
bash ./test-start.sh
```

Exit the script (press enter) to terminate the background server. Check `test-server.log` for request logs.

## Docker build

Build a lightweight container image via:

```bash
npm run build-docker
```

Then run it (ensure the template PDF is mounted into the container):

```bash
docker run --rm -p 3000:3000 \
  -e TEMPLATE_PATH=/data/template.pdf \
  -v /host/path/SNDS-LED-Preventative-Maintenance-Checklist\ BER\ Blanko.pdf:/data/template.pdf:ro \
  pm-check
```

### Docker Compose quick start

Alternatively, use the included `docker-compose.yml`:

```bash
docker compose up --build
```

This exposes the service on `http://localhost:3000`, mounts the generated PDFs from `./out`, and reuses `public/form-template.pdf` inside the container.

## Output artifacts

Generated files live under `out/`:

- `filled-<timestamp>.pdf` â€” flattened, photo-embedded checklist
- `filled-<timestamp>.json` â€” metadata (form data, files processed, placement summary)

## Troubleshooting

- **Missing template**: ensure `TEMPLATE_PATH` points to the PDF. The extractor and server return structured JSON errors when the file is missing.
- **Unexpected fields**: rerun `npm run extract-fields` after updating the template; `public/index.html` and mappings update on the next server start.
- **Image placement**: the service first looks for AcroForm button fields whose names contain `Image` or `Photo`. If none are found it falls back to drawing images on pages 3â€“4 (or the last page when fewer pages exist).

## Project structure

```
extract-fields.js   # Extracts AcroForm field metadata
server.js           # Express application and PDF processing pipeline
fields.json         # Example output produced by the extractor
mapping.json        # Optional field-name overrides
public/index.html   # Auto-generated by the server on startup
out/                # Filled PDF artifacts (gitignored)
test-start.sh       # Smoke test helper script
```

Happy automating!

